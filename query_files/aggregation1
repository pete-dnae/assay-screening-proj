select 
well_aggregation.experiment_id,
well_aggregation.qpcr_plate_id,
string_agg(well_aggregation.qpcr_well, ',' order by well_aggregation.qpcr_well) as wells,
well_aggregation.assays,
well_aggregation.transfered_assays,
well_aggregation.templates,
well_aggregation.transfered_templates
from 
(select 
merged.experiment_id,
merged.qpcr_plate_id,
merged.qpcr_well, 
string_agg(merged.assay, ',' order by merged.assay) as assays,
string_agg(merged.transfered_assay, ',' order by merged.transfered_assay) as transfered_assays,
string_agg(merged.templates, ',' order by merged.templates) as templates,
string_agg(merged.transfered_templates, ',' order by merged.transfered_templates) as transfered_templates
from 
(select  
qpcr.experiment_id,
qpcr.qpcr_plate_id,
qpcr.qpcr_well,
(case when reagents.category_id='assay' and reagents.transfer = false then reagents.reagent_id end) as assay,
(case when reagents.category_id='assay' and reagents.transfer = true then reagents.reagent_id end) as transfered_assay,
(case when reagents.category_id='template' and reagents.transfer = false then reagents.reagent_id end) as templates,
(case when reagents.category_id='template' and reagents.transfer = true then reagents.reagent_id end) as transfered_templates
from app_qpcrresultsmodel as qpcr Inner Join (
select app_reagentwelllookupmodel.well,app_reagentwelllookupmodel.reagent_id,app_reagentmodel.category_id,app_reagentwelllookupmodel.transfer
	from app_reagentwelllookupmodel 
	join app_reagentmodel on app_reagentwelllookupmodel.reagent_id = app_reagentmodel.name
) as reagents 
on qpcr.id = cast(reagents.well as int)) as merged
group by merged.experiment_id,
merged.qpcr_plate_id,
merged.qpcr_well) as well_aggregation
group by well_aggregation.experiment_id,
well_aggregation.qpcr_plate_id,
well_aggregation.assays,
well_aggregation.transfered_assays,
well_aggregation.templates,
well_aggregation.transfered_templates
-- group by reagents.reagent_id ,reagents.category_id
-- count(qpcr.qpcr_well)
-- string_agg(qpcr.qpcr_well, ',' order by qpcr.qpcr_well) as well_list